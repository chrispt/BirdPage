<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://app.birdweather.com">
    <link rel="preconnect" href="https://static.cloudflareinsights.com">
    <link rel="dns-prefetch" href="https://app.birdweather.com">
    <link rel="dns-prefetch" href="https://via.placeholder.com">
    <title>The CPTs BirdWeather PUC</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%234ecca3' d='M85 35c-5-15-20-20-35-15-10 3-18 10-22 20-3 8-2 17 3 24 2 3 5 5 8 7l-8 14c-1 2 1 4 3 3l18-8c6 2 13 2 19-1 15-8 22-28 14-44zm-45 25c-4 0-7-3-7-7s3-7 7-7 7 3 7 7-3 7-7 7z'/%3E%3C/svg%3E">
</head>
<body>
    <!-- Corner Toggles -->
    <div class="corner-toggle left" onclick="var t=document.getElementById('notificationToggle');t.checked=!t.checked;toggleNotifications()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}" role="button" tabindex="0" aria-label="Toggle notifications">
        <span class="corner-toggle-icon" aria-hidden="true">&#x1F514;</span>
        <span class="corner-toggle-label">Notifications</span>
        <label class="mini-toggle" onclick="event.stopPropagation()">
            <input type="checkbox" id="notificationToggle" onchange="toggleNotifications()" aria-label="Enable notifications">
            <span class="mini-slider"></span>
        </label>
    </div>

    <div class="corner-toggle right" onclick="var t=document.getElementById('nightModeToggle');t.checked=!t.checked;toggleNightMode()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}" role="button" tabindex="0" aria-label="Toggle night mode">
        <span class="corner-toggle-icon" id="nightModeIcon" aria-hidden="true">&#x1F31E;</span>
        <span class="corner-toggle-label">Night Mode</span>
        <label class="mini-toggle" onclick="event.stopPropagation()">
            <input type="checkbox" id="nightModeToggle" onchange="toggleNightMode()" aria-label="Enable night mode">
            <span class="mini-slider"></span>
        </label>
    </div>

    <button class="settings-btn" onclick="openSettingsModal()" aria-label="Open settings">
        <span aria-hidden="true">&#x2699;</span>
        <span>Settings</span>
    </button>

    <!-- Bird Details Modal -->
    <div id="birdModal" class="modal-overlay" onclick="closeBirdModal(event)" role="dialog" aria-modal="true" aria-labelledby="modalBirdName">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <img id="modalImage" class="modal-image" src="" alt="" loading="lazy" decoding="async">
                <button class="modal-close" onclick="closeBirdModal()" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <h2 id="modalBirdName" class="modal-bird-name"></h2>
                <p id="modalScientificName" class="modal-scientific-name"></p>

                <div class="modal-section">
                    <div class="modal-stats-grid">
                        <div class="modal-stat">
                            <div id="modalDetectionCount" class="modal-stat-value">0</div>
                            <div class="modal-stat-label">Detections (24h)</div>
                        </div>
                        <div class="modal-stat">
                            <div id="modalHighestConf" class="modal-stat-value">0%</div>
                            <div class="modal-stat-label">Match Confidence</div>
                        </div>
                        <div class="modal-stat">
                            <div id="modalLastSeen" class="modal-stat-value">--</div>
                            <div class="modal-stat-label">Last Seen</div>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3 class="modal-section-title"><span>&#x1F3B5;</span> Listen to Bird Call</h3>
                    <button id="modalPlayCall" class="bird-call-btn" onclick="playBirdCall()">
                        <span>&#x1F3B5;</span> Listen on Cornell
                    </button>
                </div>

                <div class="modal-section">
                    <h3 class="modal-section-title"><span>&#x1F5FA;</span> Range Map</h3>
                    <button id="modalRangeMapBtn" class="bird-call-btn" onclick="openRangeMap()">
                        <span>&#x1F5FA;</span> View Range Map on Cornell
                    </button>
                </div>

                <div class="modal-section">
                    <h3 class="modal-section-title"><span>&#x1F514;</span> Watch List</h3>
                    <button id="modalWatchBtn" class="watch-btn" onclick="toggleWatchSpecies()">
                        <span>&#x1F514;</span> Add to Watch List
                    </button>
                </div>

                <div class="modal-section">
                    <a id="modalCornellLink" href="#" target="_blank" rel="noopener noreferrer" class="wiki-link" style="display:inline-flex; font-size: 1rem;">
                        <span>&#x1F4D6;</span> Learn more on All About Birds
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Banner -->
    <div id="notificationBanner" class="notification-banner">
        <button class="notification-close" onclick="hideNotification()">&times;</button>
        <div class="notification-banner-title">
            <span>&#x1F426;</span> <span id="notificationTitle">New Bird Detected!</span>
        </div>
        <div id="notificationBody" class="notification-banner-body"></div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay" onclick="closeSettingsModal(event)" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modal-content settings-modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeSettingsModal()" aria-label="Close settings">&times;</button>
            <h2 id="settingsTitle">&#x2699; Pushover Settings</h2>
            <p>Get push notifications on your phone when watched birds appear, even when this page isn't open.</p>

            <div class="settings-toggle">
                <span>Enable Pushover Notifications</span>
                <label class="mini-toggle">
                    <input type="checkbox" id="pushoverEnabledToggle" onchange="togglePushoverEnabled()">
                    <span class="mini-slider"></span>
                </label>
            </div>

            <div class="settings-field">
                <label for="pushoverUserKeyInput">User Key</label>
                <input type="text" id="pushoverUserKeyInput" placeholder="Your Pushover User Key" autocomplete="off">
            </div>

            <div class="settings-field">
                <label for="pushoverAppTokenInput">App Token</label>
                <input type="text" id="pushoverAppTokenInput" placeholder="Your Pushover App Token" autocomplete="off">
            </div>

            <div class="settings-actions">
                <button class="test-btn" onclick="testPushover()">&#x1F4E4; Test</button>
                <button class="save-btn" onclick="savePushoverSettings()">&#x1F4BE; Save Settings</button>
            </div>

            <div id="settingsStatus" class="settings-status" style="display: none;"></div>

            <div class="settings-help">
                <a href="https://pushover.net" target="_blank" rel="noopener noreferrer">Get Pushover</a> ($5 one-time) &bull; Create an app in your Pushover dashboard to get your App Token
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>
                <span class="bird-icon">&#x1F426;</span>
                The CPTs BirdWeather PUC
            </h1>
            <p class="subtitle">Station #19553 - Live Bird Detections</p>
        </header>

        <!-- What's New Box -->
        <div id="whatsNewBox" class="whats-new-box">
            <div class="whats-new-header" onclick="toggleWhatsNew()">
                <div class="whats-new-title">
                    <span aria-hidden="true">&#x2728;</span>
                    What's New
                    <span class="whats-new-badge">10 Features</span>
                </div>
                <div style="display: flex; align-items: center;">
                    <span class="whats-new-arrow" aria-hidden="true">&#x25BC;</span>
                    <button class="whats-new-close" onclick="event.stopPropagation(); dismissWhatsNew()" aria-label="Dismiss What's New">&times;</button>
                </div>
            </div>
            <div class="whats-new-content">
                <div class="whats-new-list">
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F4CB;</span>
                        <div class="feature-info">
                            <div class="feature-name">Bird Details Modal</div>
                            <div class="feature-desc">Click any bird card to see detailed info, stats, and more in a beautiful popup</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F3B5;</span>
                        <div class="feature-info">
                            <div class="feature-name">Bird Call Playback</div>
                            <div class="feature-desc">Listen to bird songs and calls via Cornell's All About Birds (Macaulay Library)</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F514;</span>
                        <div class="feature-info">
                            <div class="feature-name">New Species Notifications</div>
                            <div class="feature-desc">Get alerted when a new bird species visits your feeder</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F5FA;</span>
                        <div class="feature-info">
                            <div class="feature-name">Range Maps</div>
                            <div class="feature-desc">See where each species typically lives via Cornell's All About Birds</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F7E2;</span>
                        <div class="feature-info">
                            <div class="feature-name">PUC Online Status</div>
                            <div class="feature-desc">See if the BirdWeather device is online, stale, or offline in real-time</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F4CD;</span>
                        <div class="feature-info">
                            <div class="feature-name">Live Location</div>
                            <div class="feature-desc">Shows the state where bird detections are being recorded</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x2705;</span>
                        <div class="feature-info">
                            <div class="feature-name">Clearer Confidence Labels</div>
                            <div class="feature-desc">Detection confidence now shows Excellent, Good, or Fair based on match quality</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F50A;</span>
                        <div class="feature-info">
                            <div class="feature-name">Listen to Detections</div>
                            <div class="feature-desc">Click any detection to hear the actual recording on BirdWeather</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F440;</span>
                        <div class="feature-info">
                            <div class="feature-name">Bird Watch List</div>
                            <div class="feature-desc">Watch specific birds and get notified when they appear at the feeder</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F4F1;</span>
                        <div class="feature-info">
                            <div class="feature-name">Pushover Notifications</div>
                            <div class="feature-desc">Get push notifications on your phone via Pushover integration</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot online" id="pucStatusDot"></span>
                <span id="pucStatusLabel">Checking...</span>
            </div>
            <div class="status-item" id="locationItem">
                <span id="locationDisplay">Loading...</span>
            </div>
            <div class="status-item">
                <span>Last updated: <span id="lastUpdate">--</span></span>
            </div>
            <div class="status-item">
                <span>Next refresh in: <span id="countdown" class="countdown">15:00</span></span>
            </div>
            <button class="refresh-btn" id="refreshBtn" onclick="fetchData()" aria-label="Refresh bird detection data">Refresh Now</button>
        </div>

        <div class="stats-grid" aria-live="polite" aria-atomic="false">
            <div class="stat-card">
                <div class="stat-number" id="totalDetections" aria-label="Total detections in last 24 hours">--</div>
                <div class="stat-label">Detections (24h)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uniqueSpecies" aria-label="Number of unique species">--</div>
                <div class="stat-label">Unique Species</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="latestTime" aria-label="Time of latest detection">--</div>
                <div class="stat-label">Latest Detection</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="topConfidence" aria-label="Highest detection confidence">--</div>
                <div class="stat-label">Top Confidence</div>
            </div>
        </div>

        <h2 class="section-title">
            <span>&#x1F50A;</span> <span id="sectionTitleText">Species Detected</span>
        </h2>

        <div class="view-selector">
            <label for="viewMode">Sort by:</label>
            <select id="viewMode" class="view-dropdown" onchange="changeViewMode()">
                <option value="recent">Most Recent</option>
                <option value="mostDetected">Most Detected</option>
            </select>
            <span class="time-range-note">Showing high-certainty detections from last 24 hours</span>
        </div>

        <div id="detections" class="detections-grid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading bird detections...</p>
            </div>
        </div>
    </div>

    <footer>
        <p>Data provided by <a href="https://birdweather.com" target="_blank" rel="noopener noreferrer">BirdWeather</a></p>
        <p>Updates automatically every 15 minutes</p>
    </footer>

    <!-- Main application script -->
    <script type="module" src="/src/main.js"></script>

    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "130b95c940124f70ab0dd9665ece37dd"}'></script>
</body>
</html>
