<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://app.birdweather.com">
    <link rel="preconnect" href="https://static.cloudflareinsights.com">
    <link rel="dns-prefetch" href="https://app.birdweather.com">
    <link rel="dns-prefetch" href="https://via.placeholder.com">
    <!-- Google Fonts: Inter (sans-serif), JetBrains Mono (mono) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <title>The CPTs BirdWeather PUC</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%233a7d5c' d='M85 35c-5-15-20-20-35-15-10 3-18 10-22 20-3 8-2 17 3 24 2 3 5 5 8 7l-8 14c-1 2 1 4 3 3l18-8c6 2 13 2 19-1 15-8 22-28 14-44zm-45 25c-4 0-7-3-7-7s3-7 7-7 7 3 7 7-3 7-7 7z'/%3E%3C/svg%3E">
</head>
<body>
    <!-- SVG noise filter for paper texture -->
    <svg style="position:absolute;width:0;height:0" aria-hidden="true">
        <filter id="noise">
            <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/>
        </filter>
    </svg>

    <!-- Bird Details Modal -->
    <div id="birdModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalBirdName">
        <div class="modal-content">
            <div class="modal-header">
                <img id="modalImage" class="modal-image" src="" alt="" loading="lazy" decoding="async">
                <div class="modal-name-overlay">
                    <h2 id="modalBirdName" class="modal-bird-name"></h2>
                    <p id="modalScientificName" class="modal-scientific-name"></p>
                </div>
                <button id="birdModalCloseBtn" class="modal-close" aria-label="Close modal"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">

                <div class="modal-section">
                    <div class="modal-stats-grid">
                        <div class="modal-stat">
                            <div id="modalDetectionCount" class="modal-stat-value">0</div>
                            <div class="modal-stat-label">Detections (24h)</div>
                        </div>
                        <div class="modal-stat">
                            <div id="modalHighestConf" class="modal-stat-value">0%</div>
                            <div class="modal-stat-label">Match Confidence</div>
                        </div>
                        <div class="modal-stat">
                            <div id="modalLastSeen" class="modal-stat-value">--</div>
                            <div class="modal-stat-label">Last Seen</div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <div class="modal-actions-row">
                        <button id="modalPlayCall" class="bird-call-btn">
                            <i data-lucide="volume-2"></i> Listen on Cornell
                        </button>
                        <button id="modalRangeMapBtn" class="bird-call-btn">
                            <i data-lucide="map"></i> View Range Map
                        </button>
                    </div>
                    <button id="modalWatchBtn" class="watch-btn">
                        <i data-lucide="binoculars"></i> Add to Watch List
                    </button>
                </div>

                <div class="modal-section">
                    <a id="modalCornellLink" href="#" target="_blank" rel="noopener noreferrer" class="modal-learn-more">
                        Learn more on All About Birds &rarr;
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Banner -->
    <div id="notificationBanner" class="notification-banner">
        <button class="notification-close" id="notificationCloseBtn"><i data-lucide="x"></i></button>
        <div class="notification-banner-title">
            <i data-lucide="bird"></i> <span id="notificationTitle">New Bird Detected!</span>
        </div>
        <div id="notificationBody" class="notification-banner-body"></div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modal-content settings-modal">
            <button class="modal-close" id="settingsCloseBtn" aria-label="Close settings"><i data-lucide="x"></i></button>
            <h2 id="settingsTitle"><i data-lucide="settings" style="width:20px;height:20px;vertical-align:middle;display:inline"></i> Notifications &amp; Settings</h2>

            <!-- Notifications Section -->
            <div class="settings-section">
                <h3 class="settings-section-title"><i data-lucide="bell" style="width:16px;height:16px;display:inline;vertical-align:middle"></i> Notifications</h3>
                <p class="settings-section-desc">Get alerted when new birds appear or watched birds are spotted.</p>

                <div class="settings-toggle">
                    <span>Enable Notifications</span>
                    <label class="mini-toggle">
                        <input type="checkbox" id="notificationsEnabledToggle">
                        <span class="mini-slider"></span>
                    </label>
                </div>

                <div id="notificationDetails" class="settings-info-text" style="display: none;">
                    <p>&#x2705; New species alerts &mdash; notified when a never-before-seen bird visits</p>
                    <p>&#x2705; Watched bird alerts &mdash; notified when a bird on your watch list appears</p>
                </div>
            </div>

            <hr class="settings-divider">

            <!-- Pushover Section -->
            <div class="settings-section">
                <h3 class="settings-section-title"><i data-lucide="smartphone" style="width:16px;height:16px;display:inline;vertical-align:middle"></i> Pushover</h3>
                <p class="settings-section-desc">Get push notifications on your phone, even when this page isn't open.</p>

                <div class="settings-toggle">
                    <span>Enable Pushover</span>
                    <label class="mini-toggle">
                        <input type="checkbox" id="pushoverEnabledToggle">
                        <span class="mini-slider"></span>
                    </label>
                </div>

                <div id="pushoverDetails" style="display: none;">
                    <div class="settings-field">
                        <label for="pushoverUserKeyInput">User Key</label>
                        <input type="password" id="pushoverUserKeyInput" placeholder="Your Pushover User Key" autocomplete="off">
                    </div>

                    <div class="settings-field">
                        <label for="pushoverAppTokenInput">App Token</label>
                        <input type="password" id="pushoverAppTokenInput" placeholder="Your Pushover App Token" autocomplete="off">
                    </div>
                </div>
            </div>

            <div class="settings-actions">
                <button class="test-btn" id="testPushoverBtn">Test</button>
                <button class="save-btn" id="saveSettingsBtn">Save Settings</button>
            </div>

            <div id="settingsStatus" class="settings-status" style="display: none;"></div>

            <div class="settings-help">
                <a href="https://pushover.net" target="_blank" rel="noopener noreferrer">Get Pushover</a> ($5 one-time) &bull; Create an app in your Pushover dashboard to get your App Token
            </div>
        </div>
    </div>

    <header class="site-header">
        <div class="header-inner">
            <div class="header-brand">
                <svg class="brand-mark" viewBox="0 0 100 100" width="40" height="40" aria-hidden="true">
                    <path fill="currentColor" d="M85 35c-5-15-20-20-35-15-10 3-18 10-22 20-3 8-2 17 3 24 2 3 5 5 8 7l-8 14c-1 2 1 4 3 3l18-8c6 2 13 2 19-1 15-8 22-28 14-44zm-45 25c-4 0-7-3-7-7s3-7 7-7 7 3 7 7-3 7-7 7z"/>
                </svg>
                <div>
                    <h1>The CPTs BirdWeather PUC</h1>
                    <p class="subtitle">Station #19553 &middot; Live Bird Detections</p>
                </div>
            </div>
            <div class="header-actions">
                <button id="nightModeBtn" class="header-btn" aria-label="Toggle night mode" aria-pressed="false">
                    <i id="nightModeIcon" data-lucide="sun" aria-hidden="true"></i>
                    <span class="header-btn-label">Night Mode</span>
                </button>
                <button id="settingsBtn" class="header-btn" aria-label="Open settings">
                    <i data-lucide="settings" aria-hidden="true"></i>
                    <span class="header-btn-label">Settings</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- What's New Box -->
        <div id="whatsNewBox" class="whats-new-box">
            <div class="whats-new-header" id="whatsNewHeader">
                <div class="whats-new-title">
                    <i data-lucide="sparkles" aria-hidden="true"></i>
                    What's New
                    <span class="whats-new-badge">10 Features</span>
                </div>
                <div style="display: flex; align-items: center;">
                    <i class="whats-new-arrow" data-lucide="chevron-down" aria-hidden="true"></i>
                    <button class="whats-new-close" id="whatsNewCloseBtn" aria-label="Dismiss What's New"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div class="whats-new-content">
                <div class="whats-new-list">
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F4CB;</span>
                        <div class="feature-info">
                            <div class="feature-name">Bird Details Modal</div>
                            <div class="feature-desc">Click any bird card to see detailed info, stats, and more in a beautiful popup</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F3B5;</span>
                        <div class="feature-info">
                            <div class="feature-name">Bird Call Playback</div>
                            <div class="feature-desc">Listen to bird songs and calls via Cornell's All About Birds (Macaulay Library)</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F514;</span>
                        <div class="feature-info">
                            <div class="feature-name">New Species Notifications</div>
                            <div class="feature-desc">Get alerted when a new bird species visits your feeder</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F5FA;</span>
                        <div class="feature-info">
                            <div class="feature-name">Range Maps</div>
                            <div class="feature-desc">See where each species typically lives via Cornell's All About Birds</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F7E2;</span>
                        <div class="feature-info">
                            <div class="feature-name">PUC Online Status</div>
                            <div class="feature-desc">See if the BirdWeather device is online, stale, or offline in real-time</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F4CD;</span>
                        <div class="feature-info">
                            <div class="feature-name">Live Location</div>
                            <div class="feature-desc">Shows the state where bird detections are being recorded</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x2705;</span>
                        <div class="feature-info">
                            <div class="feature-name">Clearer Confidence Labels</div>
                            <div class="feature-desc">Detection confidence now shows Excellent, Good, or Fair based on match quality</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F50A;</span>
                        <div class="feature-info">
                            <div class="feature-name">Listen to Detections</div>
                            <div class="feature-desc">Click any detection to hear the actual recording on BirdWeather</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F440;</span>
                        <div class="feature-info">
                            <div class="feature-name">Bird Watch List</div>
                            <div class="feature-desc">Watch specific birds and get notified when they appear at the feeder</div>
                        </div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">&#x1F4F1;</span>
                        <div class="feature-info">
                            <div class="feature-name">Pushover Notifications</div>
                            <div class="feature-desc">Get push notifications on your phone via Pushover integration</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Field Conditions Ribbon -->
        <div class="field-ribbon">
            <div class="ribbon-status">
                <span class="status-dot online" id="pucStatusDot"></span>
                <span id="pucStatusLabel">Checking...</span>
                <span class="ribbon-sep"></span>
                <span id="locationDisplay">Loading...</span>
            </div>
            <div class="ribbon-stats" aria-live="polite" aria-atomic="false">
                <div class="ribbon-stat">
                    <span class="ribbon-stat-value" id="totalDetections" aria-label="Total detections in last 24 hours">--</span>
                    <span class="ribbon-stat-label">Detections</span>
                </div>
                <div class="ribbon-stat">
                    <span class="ribbon-stat-value" id="uniqueSpecies" aria-label="Number of unique species">--</span>
                    <span class="ribbon-stat-label">Species</span>
                </div>
                <div class="ribbon-stat">
                    <span class="ribbon-stat-value" id="latestTime" aria-label="Time of latest detection">--</span>
                    <span class="ribbon-stat-label">Latest</span>
                </div>
                <div class="ribbon-stat">
                    <span class="ribbon-stat-value" id="topConfidence" aria-label="Highest detection confidence">--</span>
                    <span class="ribbon-stat-label">Top Match</span>
                </div>
            </div>
            <div class="ribbon-meta">
                <span>Updated: <span id="lastUpdate">--</span></span>
                <span class="ribbon-sep"></span>
                <span>Next: <span id="countdown" class="countdown">15:00</span></span>
                <button class="refresh-btn" id="refreshBtn" aria-label="Refresh bird detection data">Refresh</button>
            </div>
        </div>

        <h2 class="section-title">
            <i data-lucide="binoculars" style="width:20px;height:20px"></i> <span id="sectionTitleText">Species Detected</span>
        </h2>

        <div class="view-selector">
            <label for="viewMode">Sort by:</label>
            <select id="viewMode" class="view-dropdown">
                <option value="recent">Most Recent</option>
                <option value="mostDetected">Most Detected</option>
            </select>
            <span class="time-range-note">Showing high-certainty detections from last 24 hours</span>
        </div>

        <div id="detections" class="detections-grid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading bird detections...</p>
            </div>
        </div>
    </div>

    <footer>
        <p>Data provided by <a href="https://birdweather.com" target="_blank" rel="noopener noreferrer">BirdWeather</a></p>
        <p>Updates automatically every 15 minutes</p>
    </footer>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.468.0/dist/umd/lucide.min.js"></script>

    <!-- Main application script -->
    <script type="module" src="/src/main.js"></script>

    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "130b95c940124f70ab0dd9665ece37dd"}'></script>
</body>
</html>
